<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <id>https://vy.github.io//</id>
  <title>Volkan Yazıcı's Soap Co.</title>
  <updated>2013-04-19T08:37:00Z</updated>
  <link rel="alternate" href="https://vy.github.io//"/>
  <link rel="self" href="https://vy.github.io//blog/feed/"/>
  <author>
    <name>Volkan Yazıcı</name>
    <uri>https://vy.github.io/</uri>
  </author>
  <entry>
    <id>tag:vy.github.io,2013-04-19://blog/post/2013/04/19/benchmarking-mininet/</id>
    <title type="html">Benchmarking Mininet</title>
    <published>2013-04-19T08:37:00Z</published>
    <updated>2013-04-19T08:37:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2013/04/19/benchmarking-mininet/"/>
    <content type="html">&lt;p&gt;In the realm of software-defined networking, unless you own a data center as a play ground and have some serious amount of cash to spread over the technicians to program this infrastructure for you, you will inevitably meet with the mighty &lt;a href="https://github.com/mininet/mininet"&gt;mininet&lt;/a&gt;. mininet is a rapid prototyping tool for emulating software-defined networks. At its core, it uses process-based virtualization and network namespace tricks in Linux kernel to create a virtual network composed of controllers, hosts and switches.&lt;/p&gt;

&lt;p&gt;Recently for an experimental testbed, I needed to figure out how far can we go with mininet. That is, what is the maximum possible size of a virtual network that I can create using mininet and how long would it take to create it?&lt;/p&gt;

&lt;p&gt;Before going into the details with the benchmark, first, let me share with you the server and software specifications of the deployment environment that mininet will be running.&lt;/p&gt;

&lt;table&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Server&lt;/td&gt;
      &lt;td&gt;&lt;a href="http://www-03.ibm.com/systems/x/hardware/rack/x3650m3/"&gt;IBM System x3650 M3&lt;/a&gt;&lt;/td&gt;
    &lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Memory&lt;/td&gt;
      &lt;td&gt;28 GB (4+3*8)&lt;/td&gt;
    &lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;CPU&lt;/td&gt;
      &lt;td&gt;6-core 2.40GHz Intel Xeon E5645 CPU&lt;/td&gt;
    &lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;OS&lt;/td&gt;
      &lt;td&gt;Ubuntu 12.10 x86-64&lt;/td&gt;
    &lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Kernel&lt;/td&gt;
      &lt;td&gt;3.5.0-26-generic&lt;/td&gt;
    &lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;mininet&lt;/td&gt;
      &lt;td&gt;2.0.0d2&lt;/td&gt;
    &lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href="http://www.openvswitch.org/"&gt;Open vSwitch&lt;/a&gt;&lt;/td&gt;
      &lt;td&gt;1.4.3&lt;/td&gt;
    &lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href="http://www.openflow.org/wp/downloads/"&gt;OpenFlow Reference Implementation&lt;/a&gt;&lt;/td&gt;
      &lt;td&gt;1.0.0&lt;/td&gt;
    &lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;In order to benchmark mininet, I used a simple bash function as follows.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-bash"&gt;&lt;span class="k"&gt;for &lt;/span&gt;n in 1 &lt;span class="sb"&gt;`&lt;/span&gt;seq 32 32 1024&lt;span class="sb"&gt;`&lt;/span&gt;; &lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="k"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;"n: $n"&lt;/span&gt;
    &lt;span class="nb"&gt;echo&lt;/span&gt; -e &lt;span class="s2"&gt;"h1 free -m | grep ^Mem | awk '{print \"mem: \" \$3}'\nexit"&lt;/span&gt; | &lt;span class="se"&gt;\&lt;/span&gt;
        mn --topo&lt;span class="o"&gt;=&lt;/span&gt;linear,&lt;span class="nv"&gt;$n&lt;/span&gt; 2&amp;gt;&amp;amp;1 | &lt;span class="se"&gt;\&lt;/span&gt;
        grep -E &lt;span class="s2"&gt;"^(mem:|completed in)"&lt;/span&gt;
&lt;span class="k"&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;For varying sizes of &lt;code&gt;n&lt;/code&gt;, this command lets mininet to&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;create a virtual network composed of &lt;code&gt;n&lt;/code&gt; serially connected switches,&lt;/li&gt;
  &lt;li&gt;where a single host is attached to each switch and&lt;/li&gt;
  &lt;li&gt;the switches are connected to a central controller.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;Put another way, created network will have &lt;code&gt;2n+1&lt;/code&gt; nodes (a central controller, &lt;code&gt;n&lt;/code&gt; switches, &lt;code&gt;n&lt;/code&gt; hosts) and &lt;code&gt;3n-1&lt;/code&gt; links.&lt;/p&gt;

&lt;p&gt;Deployed script measures two things: 1) the memory usage of the server right after starting the mininet, and 2) the time it takes to start and shutdown the mininet. Results are as follows. (See &lt;a href="mininet-ovs.dat"&gt;mininet-ovs.dat&lt;/a&gt; and &lt;a href="mininet-ref.dat"&gt;mininet-ref.dat&lt;/a&gt; for raw results generated using Open vSwitch and OpenFlow reference implementation, respectively. Employed Gnuplot script &lt;a href="plot.gnu"&gt;plot.gnu&lt;/a&gt; is also shared.)&lt;/p&gt;

&lt;p&gt;&lt;img src="time.jpg" alt="Timings"&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src="memory.jpg" alt="Memory Usage"&gt;&lt;/p&gt;

&lt;p&gt;Timing numbers point out that as the number of switches increase, initialization of the whole network exposes a significant runtime overhead, regardless of the switch implementation that is used. That being said, OpenFlow reference implementation consumes a much less amount of memory compared to the Open vSwitch. On the other hand, this advantage of it should be taken with a grain of salt, because Open vSwitch is known to perform much better and supports many standards that are missing in the reference implementation. (For instance, I was once bitten by OpenFlow forwarding LLDP packets across switches, where it shouldn’t.)&lt;/p&gt;

&lt;p&gt;To sum it up, while mininet is an awesome tool to compose and emulate software-defined networks, it has its own limitations on the size of the network. These basic benchmarks should hopefully give you an idea about mininet’s runtime and memory characteristics proportional with the number of switches.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; Thanks Bob Lantz for &lt;a href="https://mailman.stanford.edu/pipermail/openflow-discuss/2013-April/004477.html"&gt;his suggestion&lt;/a&gt; on using the switch distributed with the &lt;a href="http://www.openflow.org/wp/downloads/"&gt;OpenFlow reference implementation&lt;/a&gt;.&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2013-04-14://blog/post/2013/04/14/migrating-from-blogspot/</id>
    <title type="html">Migrating from Blogspot to Nanoc</title>
    <published>2013-04-14T16:36:00Z</published>
    <updated>2013-04-14T16:36:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2013/04/14/migrating-from-blogspot/"/>
    <content type="html">&lt;p&gt;For a pretty long time, &lt;a href="http://web.itu.edu.tr/~yazicivo/"&gt;my personal website&lt;/a&gt; at İstanbul Technical University had become my attachment point with the rest of the web. Later, it is followed by &lt;a href="https://github.com/vy"&gt;GitHub&lt;/a&gt; and &lt;a href="https://twitter.com/yazicivo"&gt;Twitter&lt;/a&gt; accounts. And then in the race of trying to keep up with the internet evolution, I started writing in &lt;a href="http://vyazici.blogspot.com/"&gt;Blogspot&lt;/a&gt;. All that being said, from the very beginning I (ironically) always wanted to have a single entry point to the content originating by me. This blog post marks my first attempt in this pursuit.&lt;/p&gt;

&lt;p&gt;The startling point was Blogspot, oh yeah. First I started to type HTML by hand. Then it led to me find a JavaScript library to syntax highlight the code I share. Finally, I found myself trying to escape HTML characters within the shared code snippets. At some point I decided to use &lt;a href="https://gist.github.com/"&gt;Gist&lt;/a&gt;s. Later a reader complaint pointed out that shared Gists were not properly displayed on mobile browsers.&lt;/p&gt;

&lt;p&gt;After some research, I met with &lt;a href="http://nanoc.ws/"&gt;nanoc&lt;/a&gt;. A tiny static site generator written in Ruby. I have never used Ruby before but it didn’t take long for me to built this website in a couple of days. Thanks to the excellent documentation and the active community of nanoc. I might talk more about the obstacles that I experience during the transition, but to be honest none of the friction was due to the nanoc. (The words of &lt;a href="http://en.wikipedia.org/wiki/Bob_Ross"&gt;Bob Ross&lt;/a&gt; describes this best: &lt;em&gt;“We don’t make mistakes, just happy little accidents”&lt;/em&gt;.) Instead, I invite you to check &lt;a href="https://github.com/vy/vy.github.io/tree/source"&gt;the code&lt;/a&gt; by yourself. I hope it helps other nanoc users out there.&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2013-03-02://blog/post/2013/03/02/vehbi-koc/</id>
    <title type="html">Vehbi Koç and Influencing the Industrial Advancement of a Country</title>
    <published>2013-03-02T02:17:00Z</published>
    <updated>2013-03-02T02:17:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2013/03/02/vehbi-koc/"/>
    <content type="html">&lt;p&gt;A couple of weeks ago, I heard one of our family relatives talking about the biography of &lt;a href="http://en.wikipedia.org/wiki/Vehbi_Ko%C3%A7"&gt;Vehbi Koç&lt;/a&gt;, who started business in a small storefront and raised his legacy to a multi-billion dollar enterprise in Turkey. I had long wanted to read his auto-biography &lt;a href="http://www.amazon.com/My-Life-Story-Autobiography-Businessman/dp/B000EOXQC6/ref=sr_1_1?s=books&amp;amp;ie=UTF8&amp;amp;qid=1362228542&amp;amp;sr=1-1"&gt;My Life Story: The Autobiography of a Turkish Businessman&lt;/a&gt;. But first, I wanted to learn about his life from an objective perspective. For that purpose, I started looking for a website to purchase the &lt;a href="http://www.dogankitap.com.tr/kitap/Vehbi+Ko%C3%A7-771"&gt;Özel Arşivinden Belgeler ve Anılarıyla Vehbi Koç&lt;/a&gt; &lt;em&gt;[Vehbi Koç with Documents From His Private Archive and Memories]&lt;/em&gt; by &lt;a href="http://www.candundar.com.tr"&gt;Can Dündar&lt;/a&gt;, who is a well-known Turkish journalist, columnist and documentarian. Unfortunately, the book was out of order in every bookstore and website I visited. Then I wrote an e-mail to Can Dündar and asked him if does he have any extra copies of the book that he could share with me. He kindly mailed me the books without requesting any fees. Here I would like to express my gratitude to him for his courtesy.&lt;/p&gt;

&lt;p&gt;&lt;img src="ozel-arsiv.png" alt="Özel Arşivinden Belgeler ve Anılarıyla Vehbi Koç"&gt;&lt;/p&gt;

&lt;p&gt;Thanks to the long waiting hours in traffic while going to the work in İstanbul, I have managed reading the books in two weeks. (In the foreword, Can Dündar tells that this is a 3 books series and the last book is still under development.) Due to my previous experiences with other works of Can Dündar, it was no surprise that the work was well organized and composed of (mostly) private documents, writings, and mails stating the events and related developments in a cohesive and expressive manner. Besides the parts directly related with Vehbi Koç, the books shed significant light to the industrial, economical and political evolutions of Turkey at that time. Further, prior to reading the books, I did not know how Vehbi Koç was so influential on the development of Turkey in many aspects, some of which can be listed as introduction of new fundamental laws enabling the presence of holding and charity companies, first car industry, first local hotels in the line of Hilton, marvelous hospital, railway, industry constructions that are still standing up and are well respected in their fields today. In addition, the books mention about the struggles he had, the industrial and political obstacles that are put in front of him by other people, how he always managed to surmount by his honesty and hard working.&lt;/p&gt;

&lt;p&gt;All in all, now I see Vehbi Koç as not just a business man, but a pioneer in the advancement of Turkey who contributed many artwork that are ground breaking and exposing new potentials in their fields, even now. While &lt;a href="http://en.wikipedia.org/wiki/Ko%C3%A7_Holding"&gt;Koç Holding A.Ş.&lt;/a&gt; is still one of the top industrial conglomerates in the world, his achievements were ahead of his time and something that, in addition to his own children, even I am proud of.&lt;/p&gt;

&lt;hr&gt;&lt;p&gt;&lt;strong&gt;Edit:&lt;/strong&gt; Today, I had chance to finish reading &lt;a href="http://www.amazon.com/My-Life-Story-Autobiography-Businessman/dp/B000EOXQC6/ref=sr_1_1?s=books&amp;amp;ie=UTF8&amp;amp;qid=1362228542&amp;amp;sr=1-1"&gt;My Life Story: The Autobiography of a Turkish Businessman&lt;/a&gt; as well. Majority of the content is in line with what was presented in Can Dündar’s books.&lt;/p&gt;

&lt;p&gt;&lt;img src="hayat-hikayem.jpg" alt="Hayat Hikayem"&gt;&lt;/p&gt;

&lt;p&gt;In the section, where Vehbi Koç mentions about his visit to Japan in 1970, I found a pointer to a journal article series (dating back to 24, 25, 26 March, 1970) that he shares his notes and comments about the visit. I found the articles quite important in terms of understanding the development history of Japan and its comparison with Turkey at that time. But more importantly, it gives hints about the way Vehbi Koç thinks while analyzing a whole new country with an extraordinary cultural, governmental, economical and industrial structure.&lt;/p&gt;

&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;&lt;a href="24.jpg"&gt;&lt;img src="24-small.jpg" alt="24 March"&gt;&lt;/a&gt;&lt;/td&gt;
      &lt;td&gt;&lt;a href="25.jpg"&gt;&lt;img src="25-small.jpg" alt="25 March"&gt;&lt;/a&gt;&lt;/td&gt;
      &lt;td&gt;&lt;a href="26.jpg"&gt;&lt;img src="26-small.jpg" alt="26 March"&gt;&lt;/a&gt;&lt;/td&gt;
    &lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;I hope others interested in the subject would find them useful as well.&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2012-11-30://blog/post/2012/11/30/merging-two-binary-search-trees/</id>
    <title type="html">Merging Two Binary Search Trees in O(logn) Space</title>
    <published>2012-11-30T04:01:00Z</published>
    <updated>2012-11-30T04:01:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2012/11/30/merging-two-binary-search-trees/"/>
    <content type="html">&lt;p&gt;In a recent coding interview, I was asked to merge two &lt;a href="http://en.wikipedia.org/wiki/Binary_search_tree"&gt;Binary Search Tree&lt;/a&gt;s (BSTs) without modifying them. This was the first time I was exposed to this question and for an hour or so I tried to come up with a linear time algorithm of O(1) space complexity. The defeat was inevitable. (To tell the truth, if a hint would be given like O(m+n) storage is allowed, I could easily figure out the solution without breaking a sweat.) As usual, I could not sleep that night and scratched dozens of papers to come up with a better solution. But as night passed, I started to realize the fact that the space complexity is lower bounded by the tree height. This blog post is set to keep a cyber-record of this pursuit.&lt;/p&gt;

&lt;h1 id="related-work"&gt;Related Work&lt;/h1&gt;

&lt;p&gt;You can first start by checking the &lt;a href="https://www.google.com/search?q=merge+binary+search+tree"&gt;Google results&lt;/a&gt;. But, as usual, I am kind enough to provide you a tl;dr version: In order to merge two BSTs of size m and n nodes, there are a couple of common approaches of fixed O(m+n) processing time and space complexity, some of which are listed as follows.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Insert given BSTs into a newly created BST.&lt;/li&gt;
  &lt;li&gt;Create an array of elements of the first BST in sorted order, and use this array to merge the results to a new BST while traversing the second BST.&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Further exposure to the higher doses of the problem is available through &lt;a href="http://stackoverflow.com/questions/1008513/how-to-merge-two-bsts-efficiently"&gt;this&lt;/a&gt; and &lt;a href="http://stackoverflow.com/questions/7540546/merging-2-binary-search-trees"&gt;this&lt;/a&gt; StackOverflow threads.&lt;/p&gt;

&lt;h1 id="on-complexity"&gt;On Complexity&lt;/h1&gt;

&lt;p&gt;You will definitely need an O(m+n) processing complexity to visit each node, that’s for sure. But what about O(m+n) space complexity? It means that you need to store one (or both) of the given trees in a vector in order to proceed with the merge. As it will turn out in the following paragraphs, actually space complexity is lower-bounded by the height of the tree, that is, O(h), where h=logn for a balanced tree.&lt;/p&gt;

&lt;h1 id="the-trick"&gt;The Trick&lt;/h1&gt;

&lt;p&gt;In its most basic form, we flatten both trees into two separate vectors. Next, we consume one element at a time from either of the trees with the smallest element. This scheme deserves a figure of its own.&lt;/p&gt;

&lt;p&gt;&lt;img src="mn-space.jpg" alt="Solution with O(m+n) space complexity."&gt;&lt;/p&gt;

&lt;p&gt;It is certain that we effectively don’t need the whole elements of a tree packed into a single vector at once. At each step, what we ask for is the next smallest element. That is, we just need a &lt;em&gt;stream&lt;/em&gt; of nodes traversed in-order.&lt;/p&gt;

&lt;p&gt;Let’s further investigate the possibility of implementing a stream of nodes. In order to consume the elements of a binary search tree in sorted order, we need to traverse the tree in left-center-right node order. Assume that we have below traversal function. (Yes, it is in C++ and I shamelessly used templates.)&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-c++"&gt;&lt;span class="k"&gt;template&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="n"&gt;traverse&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Node&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;*&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;items&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
  &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;traverse&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;left&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
    &lt;span class="n"&gt;items&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;push&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
    &lt;span class="n"&gt;traverse&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;right&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
  &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;What if I can suspend the execution at any point in time while pushing the data to a queue? In that case, what would be the maximum possible height of a recursive &lt;code&gt;traverse()&lt;/code&gt; call stack? I know you like figures, so I took another photo of the board.&lt;/p&gt;

&lt;p&gt;&lt;img src="tree-height.jpg" alt="Relation with tree height."&gt;&lt;/p&gt;

&lt;p&gt;That is, the maximum call stack depth of a &lt;code&gt;traverse()&lt;/code&gt; recursion is upper-bounded by the tree height. Coupled with the fact that successive &lt;code&gt;traverse()&lt;/code&gt; calls are sufficient to consume the nodes of a tree in sorted order, we should be able to stream the nodes of tree with at most O(logn) node pointers.&lt;/p&gt;

&lt;h1 id="streaming-nodes"&gt;Streaming Nodes&lt;/h1&gt;

&lt;p&gt;Since actual traverse call stack is bounded, we can emulate the recursive traverse using a stack of the nodes traversed so far from the root. The outline of the streaming algorithm is as follows.&lt;/p&gt;

&lt;p&gt;&lt;img src="algorithm.jpg" alt="Node streaming algorithm."&gt;&lt;/p&gt;

&lt;h1 id="the-prestige"&gt;The Prestige&lt;/h1&gt;

&lt;p&gt;Now we can stream a tree in sorted order using at most O(logn) storage. The rest is easy: Stream both trees and merge them while streaming.&lt;/p&gt;

&lt;h1 id="the-code"&gt;The Code&lt;/h1&gt;

&lt;p&gt;I implemented a streamer (&lt;code&gt;NodeStream&lt;/code&gt;), stream merger (&lt;code&gt;MergeNodeStream&lt;/code&gt;), and a vector merger (&lt;code&gt;MergeNodeVector&lt;/code&gt;) in C++ and Scala. Code is accessible through this &lt;a href="https://gist.github.com/4171977"&gt;Gist&lt;/a&gt;. You can also find implementations of the algorithm in &lt;a href="https://gist.github.com/8be224c9cfb423dcc0f3"&gt;C++ using Boost Coroutines&lt;/a&gt; and &lt;a href="https://gist.github.com/4181097"&gt;Haskell&lt;/a&gt; written by &lt;a href="http://www.blogger.com/profile/01427008889073096042"&gt;Remko&lt;/a&gt;.&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2012-11-28://blog/post/2012/11/28/setting-up-a-scala-dev-env/</id>
    <title type="html">Scala Development Environment with Intellij IDEA and SBT</title>
    <published>2012-11-28T04:46:00Z</published>
    <updated>2012-11-28T04:46:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2012/11/28/setting-up-a-scala-dev-env/"/>
    <content type="html">&lt;p&gt;Resisting against the &lt;a href="https://class.coursera.org/progfun-2012-001/"&gt;Functional Programming Principles in Scala&lt;/a&gt; buzz was meaningless. After all, this or that way I know I would be repeating those steps on my own regardless of the presence of such a lecture. To warm up, I looked around for an appropriate development environment for Scala. The last time (~2 years ago) I repeated this same step ended up with a desperate search. Fortunately, reading dozens of blog posts, forum/mailing-list threads, GitHub README’s, repeating try-and-fail procedures leaded me to a working setup. To mitigate the friction at least to an extent for new comers, I put up this blog post to make a list of steps in order to setup a working Scala development environment on top of &lt;a href="http://www.jetbrains.com/idea"&gt;IntelliJ IDEA&lt;/a&gt; with &lt;a href="http://www.scala-sbt.org/"&gt;SBT&lt;/a&gt; integration.&lt;/p&gt;

&lt;h1 id="is-there-a-scala-plugin-available-for-idea"&gt;Is there a Scala plugin available for IDEA?&lt;/h1&gt;

&lt;p&gt;Good news, yes. &lt;a href="http://confluence.jetbrains.net/display/SCA/Scala+Plugin+for+IntelliJ+IDEA"&gt;It&lt;/a&gt; is under active development, works way better than its alternatives, has a responsive maintainer and an active &lt;a href="http://devnet.jetbrains.net/community/idea/scala?view=discussions"&gt;community&lt;/a&gt;. Plugin lets you create Scala projects, compile/run/debug Scala source files, scripts, and worksheets. Navigation, refactoring, tab-completion, code snippets are included as well. (Note that it is &lt;em&gt;strongly&lt;/em&gt; advised to use an &lt;a href="http://confluence.jetbrains.net/display/IDEADEV/EAP"&gt;EAP&lt;/a&gt; version for a smooth experience.)&lt;/p&gt;

&lt;h1 id="is-there-a-quick-start-guide-for-idea-scala-plugin"&gt;Is there a quick start guide for IDEA Scala plugin?&lt;/h1&gt;

&lt;p&gt;Yes, see &lt;a href="http://confluence.jetbrains.net/display/SCA/Getting+Started+with+IntelliJ+IDEA+Scala+Plugin"&gt;Getting Started with IntelliJ IDEA Scala Plugin&lt;/a&gt;.&lt;/p&gt;

&lt;h1 id="how-do-i-manage-project-dependencies"&gt;How do I manage project dependencies?&lt;/h1&gt;

&lt;p&gt;While one can setup a Maven/Ivy/Ant configuration for a Scala project, &lt;a href="http://www.scala-sbt.org/"&gt;SBT&lt;/a&gt; is known to be the de-facto tool for build management throughout the Scala community. (Otherwise, you will need to set explicit scala-compiler and scala-library dependencies in XML mazes.) Fortunately, there is an &lt;a href="http://plugins.intellij.net/plugin?pr=idea&amp;amp;pluginId=5007"&gt;SBT plugin&lt;/a&gt; for IDEA. It offers a console where SBT commands can be entered interactively, and a &lt;em&gt;Before Launch&lt;/em&gt; task to delegate project compilation to SBT, as an alternative to the built in IntelliJ Make.&lt;/p&gt;

&lt;h1 id="is-there-a-quick-start-guide-for-sbt"&gt;Is there a quick start guide for SBT?&lt;/h1&gt;

&lt;p&gt;Yes, see &lt;a href="http://www.scala-sbt.org/release/docs/Getting-Started/Hello.html"&gt;Hello, World&lt;/a&gt; in &lt;a href="http://www.scala-sbt.org/release/docs/index.html"&gt;SBT documentation&lt;/a&gt;.&lt;/p&gt;

&lt;h1 id="how-can-i-integrate-libraries-installed-by-sbt-to-idea"&gt;How can I integrate libraries installed by SBT to IDEA?&lt;/h1&gt;

&lt;p&gt;At its core, SBT uses &lt;a href="http://ant.apache.org/ivy/"&gt;Apache Ivy&lt;/a&gt;, which has its own nasty ways of dealing with downloaded JARs under &lt;code&gt;~/.ivy2&lt;/code&gt;. Instead of manually defining IDEA module dependencies for each JAR a project uses, lucky for us, there exists an SBT plugin for this purpose: &lt;a href="https://github.com/mpeltonen/sbt-idea"&gt;sbt-idea&lt;/a&gt;. Basically, sbt-idea enhances SBT with a new task, called &lt;em&gt;gen-idea&lt;/em&gt;, which creates IDEA project files with necessary module dependencies induced by SBT. That is,&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Add your dependencies to your SBT configuration,&lt;/li&gt;
  &lt;li&gt;Call &lt;code&gt;sbt update&lt;/code&gt; to download/update project dependencies,&lt;/li&gt;
  &lt;li&gt;Call &lt;code&gt;sbt gen-idea&lt;/code&gt; to create IDEA project files,&lt;/li&gt;
  &lt;li&gt;Open created project from IDEA.&lt;/li&gt;
&lt;/ol&gt;&lt;h1 id="what-are-the-idea-modules-created-by-sbt-idea"&gt;What are the IDEA modules created by sbt-idea?&lt;/h1&gt;

&lt;p&gt;In addition to below directories, SBT dependencies are added to the IDEA module configuration.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;
&lt;strong&gt;Source Folders:&lt;/strong&gt; &lt;code&gt;src/main/{scala,java,resources}&lt;/code&gt;
&lt;/li&gt;
  &lt;li&gt;
&lt;strong&gt;Test Source Folders:&lt;/strong&gt; &lt;code&gt;src/test/{scala,java,resources}&lt;/code&gt;
&lt;/li&gt;
&lt;/ul&gt;&lt;h1 id="what-about-testing"&gt;What about testing?&lt;/h1&gt;

&lt;p&gt;SBT supports a couple of testing frameworks, e.g., &lt;a href="http://etorreborre.github.com/specs2/"&gt;specs2&lt;/a&gt;, &lt;a href="http://code.google.com/p/scalacheck/"&gt;ScalaCheck&lt;/a&gt;, and
&lt;a href="http://www.artima.com/scalatest/"&gt;ScalaTest&lt;/a&gt;. See &lt;a href="http://www.scala-sbt.org/release/docs/Detailed-Topics/Testing.html"&gt;Testing&lt;/a&gt; section of the SBT documentation for a detailed discussion.&lt;/p&gt;

&lt;h1 id="what-about-my-gitignore"&gt;What about my &lt;code&gt;.gitignore&lt;/code&gt;?&lt;/h1&gt;

&lt;p&gt;Here you go.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/.idea
/.idea_modules
target/
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id="i-read-enough-gimme-the-code"&gt;I read enough, gimme the code!&lt;/h1&gt;

&lt;p&gt;Create a project directory.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-bash"&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="nb"&gt;export &lt;/span&gt;&lt;span class="nv"&gt;PROJECT_DIR&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;~/scala/ScalaHelloWorld
&lt;span class="nv"&gt;$ &lt;/span&gt;mkdir &lt;span class="nv"&gt;$PROJECT_DIR&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Create &lt;code&gt;$PROJECT_DIR/build.sbt&lt;/code&gt; as follows. (In this example, I used ScalaTest framework.)&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-scala"&gt;&lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="s"&gt;"ScalaHelloWorld"&lt;/span&gt;
 
&lt;span class="n"&gt;version&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="s"&gt;"0.0.1"&lt;/span&gt;
 
&lt;span class="n"&gt;scalaVersion&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="s"&gt;"2.9.2"&lt;/span&gt;
 
&lt;span class="n"&gt;libraryDependencies&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="s"&gt;"org.scalatest"&lt;/span&gt; &lt;span class="o"&gt;%%&lt;/span&gt; &lt;span class="s"&gt;"scalatest"&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="s"&gt;"1.8"&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="s"&gt;"test"&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Create &lt;code&gt;$PROJECT_DIR/project&lt;/code&gt; directory and add below lines to &lt;code&gt;$PROJECT_DIR/project/plugins.sbt&lt;/code&gt; to add sbt-idea plugin.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-scala"&gt;&lt;span class="n"&gt;resolvers&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="s"&gt;"Sonatype snapshots"&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="s"&gt;"http://oss.sonatype.org/content/repositories/snapshots/"&lt;/span&gt;
 
&lt;span class="n"&gt;addSbtPlugin&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"com.github.mpeltonen"&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="s"&gt;"sbt-idea"&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="s"&gt;"1.2.0-SNAPSHOT"&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Run &lt;code&gt;sbt&lt;/code&gt; in &lt;code&gt;$PROJECT_DIR&lt;/code&gt; and execute &lt;code&gt;gen-idea&lt;/code&gt; task.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-bash"&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;sbt
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Loading project definition from /home/vy/scala/ScalaHelloWorld/project
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Updating &lt;span class="o"&gt;{&lt;/span&gt;file:/home/vy/scala/ScalaHelloWorld/project/&lt;span class="o"&gt;}&lt;/span&gt;default-70d248...
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Resolving org.scala-sbt#precompiled-2_10_0-m7;0.12.1 ...
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Done updating.
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Set current project to ScalaHelloWorld &lt;span class="o"&gt;(&lt;/span&gt;in build file:/home/vy/scala/ScalaHelloWorld/&lt;span class="o"&gt;)&lt;/span&gt;
&amp;gt; gen-idea
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Trying to create an Idea module ScalaHelloWorld
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Updating &lt;span class="o"&gt;{&lt;/span&gt;file:/home/vy/scala/ScalaHelloWorld/&lt;span class="o"&gt;}&lt;/span&gt;default-3005c4...
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Resolving org.scalatest#scalatest_2.9.2;1.8 ...
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Done updating.
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Resolving org.scalatest#scalatest_2.9.2;1.8 ...
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Excluding folder target
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Created /home/vy/scala/ScalaHelloWorld/.idea/IdeaProject.iml
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Created /home/vy/scala/ScalaHelloWorld/.idea
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Excluding folder /home/vy/scala/ScalaHelloWorld/target
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Created /home/vy/scala/ScalaHelloWorld/.idea_modules/ScalaHelloWorld.iml
&lt;span class="o"&gt;[&lt;/span&gt;info&lt;span class="o"&gt;]&lt;/span&gt; Created /home/vy/scala/ScalaHelloWorld/.idea_modules/ScalaHelloWorld-build.iml
&amp;gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In &lt;code&gt;src/main/scala/Main.scala&lt;/code&gt;, create a &lt;code&gt;main()&lt;/code&gt; stub with a testable function in it.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-scala"&gt;&lt;span class="k"&gt;object&lt;/span&gt; &lt;span class="nc"&gt;Main&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;main&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Array&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;String&lt;/span&gt;&lt;span class="o"&gt;])&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"Hello, World!"&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"# of arguments: %d"&lt;/span&gt; &lt;span class="n"&gt;format&lt;/span&gt; &lt;span class="n"&gt;count&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;count&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;T&lt;/span&gt;&lt;span class="o"&gt;](&lt;/span&gt;&lt;span class="n"&gt;it&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;T&lt;/span&gt;&lt;span class="o"&gt;])&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;it&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In &lt;code&gt;src/test/scala/MainSuite.scala&lt;/code&gt;, create a sample test suite.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-scala"&gt;&lt;span class="k"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;org.scalatest.FunSuite&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MainSuite&lt;/span&gt; &lt;span class="k"&gt;extends&lt;/span&gt; &lt;span class="nc"&gt;FunSuite&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;test&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"counting an empty collection"&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;assert&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Main&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;count&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Array&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;]())&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;assert&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Main&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;count&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Map&lt;/span&gt;&lt;span class="o"&gt;())&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;assert&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Main&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;count&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Set&lt;/span&gt;&lt;span class="o"&gt;())&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="n"&gt;test&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"counting a non-empty collection"&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;assert&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Main&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;count&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Array&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;assert&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Main&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;count&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Map&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;assert&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Main&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;count&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Set&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Enjoy the rest by either creating your own IDEA run configurations, or manually running tasks within the SBT console. (As a final note, while creating IDEA run configurations, you can use SBT &lt;em&gt;Before Launch&lt;/em&gt; task provided by IDEA SBT plugin.)&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2012-09-30://blog/post/2012/09/30/sequential-chaining-of-nested-callbacks/</id>
    <title type="html">Sequential Chaining of Nested Callbacks</title>
    <published>2012-09-30T03:26:00Z</published>
    <updated>2012-09-30T03:26:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2012/09/30/sequential-chaining-of-nested-callbacks/"/>
    <content type="html">&lt;p&gt;Back in the old days of programming, the days we used to have blocking function calls, things were easy: &lt;em&gt;first&lt;/em&gt; do this, and &lt;em&gt;then&lt;/em&gt; do that, and &lt;em&gt;finally&lt;/em&gt; clean things up. While this sequential style of programming has its own advantages in terms of human perception, it imposes certain concurrency related limitations. That is, each expression in a program is supposed to wait for the completion of the execution flow up until the line above, regardless of if it has anything to do with the current expression or not. Asynchronious programs are known to solve this problem of concurrency, (at least, to some extent) with the cost of sacrificing the sequential program flow. At its most basic form, functions are provided interfaces to specify dependencies between each other and hence, independent functions are allowed to execute concurrently. These interfaces are generally provided in the form of callback functions, that is, when &lt;code&gt;f()&lt;/code&gt; gets completed do &lt;code&gt;g()&lt;/code&gt;, and when &lt;code&gt;g()&lt;/code&gt; completes do &lt;code&gt;h()&lt;/code&gt;, and so on. The premise of this blog post is to investigate whether it is possible to still preserve the dependency between functions by still allowing the programmer to syntatically structure the program sequentially.&lt;/p&gt;

&lt;p&gt;&lt;img src="seq-tran.png" alt="Sequential vs. Concurrent Program Flow"&gt;&lt;/p&gt;

&lt;p&gt;In the context of asynchronious programming, JavaScript is an exceptional example, where almost every functionality in the language is shaped according to asynchronous callbacks, which eventually enforces you to program in a totally top-down callback-oriented style. In this post, I prefered to use CoffeeScript (which is a programming language compiled to JavaScript) to enhance the plain text the explanations.&lt;/p&gt;

&lt;p&gt;Ok, enough talk. Let’s start with working on a small sequential program snippet.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="k"&gt;try&lt;/span&gt;
    &lt;span class="nv"&gt;conn = &lt;/span&gt;&lt;span class="nx"&gt;db&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;open&lt;/span&gt; &lt;span class="s"&gt;"local"&lt;/span&gt;
    &lt;span class="nv"&gt;rows = &lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;query&lt;/span&gt; &lt;span class="s"&gt;"SELECT key, val FROM entries"&lt;/span&gt;
    &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;result: &lt;/span&gt;&lt;span class="nx"&gt;rows&lt;/span&gt;
&lt;span class="k"&gt;catch&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;
    &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Simple and intuitive. You just grab the logic behind at first sight: &lt;em&gt;First&lt;/em&gt;, connect to the database, and &lt;em&gt;then&lt;/em&gt; query the rows of a table, and &lt;em&gt;finally&lt;/em&gt; close the connection and return the results. And as a bonus you can catch errors that would occur during this sequence. Here is its asynchronious, callback-driven counterpart:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="c1"&gt;# Erronous try-catch block. (db.open might have been completed and the&lt;/span&gt;
&lt;span class="c1"&gt;# catch block would be passed over.)&lt;/span&gt;
&lt;span class="k"&gt;try&lt;/span&gt;
    &lt;span class="nx"&gt;db&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;open&lt;/span&gt; &lt;span class="s"&gt;"local"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(conn) -&amp;gt;&lt;/span&gt;
        &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;query&lt;/span&gt; &lt;span class="s"&gt;"SELECT key, val FROM entries"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(rows) -&amp;gt;&lt;/span&gt;
            &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
            &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;result: &lt;/span&gt;&lt;span class="nx"&gt;rows&lt;/span&gt;
&lt;span class="k"&gt;catch&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;
    &lt;span class="nx"&gt;util&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;log&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;
    &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Um… Not as intiutive as its sequential counterpart. And the nested callback chains expands the code to the right, which makes it harder to understand as well. But, not that bad… with a serious glitch: Orphan exceptions. That is, for instance, who is supposed to catch a &lt;code&gt;connection error&lt;/code&gt; exception after &lt;code&gt;db.open&lt;/code&gt; completes gracefully and the execution passes over the try-catch block? While code will be get polluted a little bit, this problem can be tackled by returning an error, instead of raising an exception.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="nx"&gt;db&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;open&lt;/span&gt; &lt;span class="s"&gt;"local"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err, conn) -&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"connection error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
    &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;query&lt;/span&gt; &lt;span class="s"&gt;"SELECT key, val FROM entries"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err, rows) -&amp;gt;&lt;/span&gt;
        &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"query error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
        &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;result: &lt;/span&gt;&lt;span class="nx"&gt;rows&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Better now, at least in terms of correctness.&lt;/p&gt;

&lt;p&gt;So far, we always beforehand knew the callbacks that will be nested into each other. That is, we knew that a simple query will follow just after the database connection gets established. What if we wouldn’t? What if the next callback is to be dynamically determined according to a runtime variable? Think about this scenario: You need to query the database multiple times depending on the input passed by the user. A pretty common day-to-day practice. Terrorizing the code with unknown number of nested callbacks would buy us no credits.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="nv"&gt;ids = &lt;/span&gt;&lt;span class="p"&gt;[...]&lt;/span&gt; &lt;span class="c1"&gt;# The user provided input.&lt;/span&gt;

&lt;span class="nv"&gt;totalRows = &lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt;
&lt;span class="nx"&gt;db&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;open&lt;/span&gt; &lt;span class="s"&gt;"local"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err, conn) -&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"connection error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
    &lt;span class="nv"&gt;id = &lt;/span&gt;&lt;span class="nx"&gt;ids&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;pop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="k"&gt;unless&lt;/span&gt; &lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
    &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;query&lt;/span&gt; &lt;span class="s"&gt;"SELECT key, val FROM entries WHERE id = &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err, rows) -&amp;gt;&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
            &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"query error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;
        &lt;span class="nx"&gt;totalRows&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="nx"&gt;rows&lt;/span&gt;
        &lt;span class="nv"&gt;id = &lt;/span&gt;&lt;span class="nx"&gt;ids&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;pop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="k"&gt;unless&lt;/span&gt; &lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
        &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;query&lt;/span&gt; &lt;span class="s"&gt;"SELECT key, val FROM entries WHERE id = &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err, rows) -&amp;gt;&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
                &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
                &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"query error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;
            &lt;span class="nx"&gt;totalRows&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="nx"&gt;rows&lt;/span&gt;
            &lt;span class="nv"&gt;id = &lt;/span&gt;&lt;span class="nx"&gt;ids&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;pop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="k"&gt;unless&lt;/span&gt; &lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
            &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;query&lt;/span&gt; &lt;span class="s"&gt;"SELECT key, val FROM entries WHERE id = &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err, rows) -&amp;gt;&lt;/span&gt;
                &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
                    &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
                    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"query error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;
                &lt;span class="nx"&gt;totalRows&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="nx"&gt;rows&lt;/span&gt;
                &lt;span class="c1"&gt;# ...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On the other hand, forming nested callbacks using a recursive function solves the problem.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="nv"&gt;ids = &lt;/span&gt;&lt;span class="p"&gt;[...]&lt;/span&gt; &lt;span class="c1"&gt;# The user provided input.&lt;/span&gt;

&lt;span class="nx"&gt;db&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;open&lt;/span&gt; &lt;span class="s"&gt;"local"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err, conn) -&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"connection error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
    &lt;span class="nv"&gt;f = &lt;/span&gt;&lt;span class="nf"&gt;(accum) -&amp;gt;&lt;/span&gt;
        &lt;span class="nv"&gt;id = &lt;/span&gt;&lt;span class="nx"&gt;ids&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;pop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;not&lt;/span&gt; &lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
            &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;accum&lt;/span&gt;
        &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;query&lt;/span&gt; &lt;span class="s"&gt;"SELECT key, val FROM entries WHERE id = &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err, rows) -&amp;gt;&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
                &lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
                &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"query error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;
            &lt;span class="nx"&gt;f&lt;/span&gt; &lt;span class="nx"&gt;accum&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;rows&lt;/span&gt;
    &lt;span class="nx"&gt;f&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I admit that this is not intuitive, also more error-prone. (I also could not be sure if I wrote it right. But anyway, you get the idea.) There must be some other way. Wouldn’t it be cute if there would exist some sort of &lt;em&gt;sequencer&lt;/em&gt; mechanism that allows me to sequentially chain my nested callbacks?&lt;/p&gt;

&lt;p&gt;&lt;img src="yo-dawg.png" alt="Yo dawg!"&gt;&lt;/p&gt;

&lt;p&gt;This &lt;em&gt;Aha!&lt;/em&gt; moment helped me to come up with below tiny helper class.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nx"&gt;SequentialExecutor&lt;/span&gt;
    &lt;span class="nv"&gt;tasks: &lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt;
    &lt;span class="nv"&gt;pos: &lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;
    &lt;span class="nv"&gt;add: &lt;/span&gt;&lt;span class="nf"&gt;(task) =&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;@tasks&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;push&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;task&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;@run&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="nv"&gt;run: &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;@tasks&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nx"&gt;@pos&lt;/span&gt;&lt;span class="o"&gt;++&lt;/span&gt;&lt;span class="p"&gt;]()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;SequentialExecutor&lt;/code&gt; helps you to push your functions into an array and executes them in order for you. Specifically, it passes you the pointer to the next function (i.e., &lt;code&gt;next&lt;/code&gt;) that is supposed to be executed after current function. So, it is up to you to execute it or not. Here is an example using this cute &lt;code&gt;SequentialExecutor&lt;/code&gt; class:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="nv"&gt;exec = &lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nx"&gt;SequentialExecutor&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt; &lt;span class="nf"&gt;(next) -&amp;gt;&lt;/span&gt;
    &lt;span class="nx"&gt;db&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;open&lt;/span&gt; &lt;span class="s"&gt;"local"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err, conn) -&amp;gt;&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"connection error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
        &lt;span class="nv"&gt;exec.conn = &lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;
        &lt;span class="nx"&gt;next&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt; &lt;span class="nf"&gt;(next) -&amp;gt;&lt;/span&gt;
    &lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;query&lt;/span&gt; &lt;span class="s"&gt;"SELECT key, val FROM entries"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err, rows) -&amp;gt;&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"query error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
        &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;result: &lt;/span&gt;&lt;span class="nx"&gt;rows&lt;/span&gt;
        &lt;span class="nx"&gt;next&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt; &lt;span class="nf"&gt;(next) -&amp;gt;&lt;/span&gt;
    &lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;run&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Yes, now we have something! Let’s also try to implement the case where the total number of queries are dynamically determined on the run.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="nv"&gt;exec = &lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nx"&gt;SequentialExecutor&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt; &lt;span class="nf"&gt;(next) -&amp;gt;&lt;/span&gt;
    &lt;span class="nx"&gt;db&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;open&lt;/span&gt; &lt;span class="s"&gt;"local"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err, conn) -&amp;gt;&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"connection error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
        &lt;span class="nv"&gt;exec.conn = &lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;
        &lt;span class="nx"&gt;next&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt; &lt;span class="nf"&gt;(next) -&amp;gt;&lt;/span&gt;
    &lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;query&lt;/span&gt; &lt;span class="s"&gt;"SELECT key, val FROM entries"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err, rows) -&amp;gt;&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"query error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;

        &lt;span class="c1"&gt;# Errounous dynamic task creation. exec.conn.close() will be evaluated&lt;/span&gt;
        &lt;span class="c1"&gt;# earlier then the insert tasks created within this task.&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="nx"&gt;row&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="nx"&gt;rows&lt;/span&gt;
            &lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt; &lt;span class="nf"&gt;(next) -&amp;gt;&lt;/span&gt;
                &lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;insert&lt;/span&gt; &lt;span class="nv"&gt;key: &lt;/span&gt;&lt;span class="nx"&gt;row&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;key&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;val: &lt;/span&gt;&lt;span class="nx"&gt;row&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;val&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err) -&amp;gt;&lt;/span&gt;
                    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"insert error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
                    &lt;span class="nx"&gt;next&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt; &lt;span class="nf"&gt;(next) -&amp;gt;&lt;/span&gt;
            &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt;
            &lt;span class="nx"&gt;next&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

        &lt;span class="nx"&gt;next&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt; &lt;span class="nf"&gt;(next) -&amp;gt;&lt;/span&gt;
    &lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;run&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="cm"&gt;###&lt;/span&gt;
&lt;span class="cm"&gt;Step | Command&lt;/span&gt;
&lt;span class="cm"&gt;-----+------------------&lt;/span&gt;
&lt;span class="cm"&gt;  1  | db.open&lt;/span&gt;
&lt;span class="cm"&gt;  2  | exec.conn.query&lt;/span&gt;
&lt;span class="cm"&gt;  3  | exec.conn.close (BOOM!)&lt;/span&gt;
&lt;span class="cm"&gt;  4  | exec.conn.insert&lt;/span&gt;
&lt;span class="cm"&gt;  5  | exec.conn.insert&lt;/span&gt;
&lt;span class="cm"&gt; ...&lt;/span&gt;
&lt;span class="cm"&gt; n-1 | exec.conn.insert&lt;/span&gt;
&lt;span class="cm"&gt;  n  | user_send&lt;/span&gt;
&lt;span class="cm"&gt;###&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Oops! That is not what we were expecting. Database connection is supposed to be closed at the end of the execution flow. Hrm… Can’t we enhance &lt;code&gt;SequentialExecutor&lt;/code&gt; to label tasks with priorities? Here is the poor man’s sequential executor with priority support.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="nv"&gt;Heap = &lt;/span&gt;&lt;span class="nx"&gt;require&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"heap"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nx"&gt;SequentialExecutor&lt;/span&gt;
	&lt;span class="nv"&gt;tasks: &lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nx"&gt;Heap&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;(u, v) -&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;u&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;rank&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="nx"&gt;v&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;rank&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
	&lt;span class="nv"&gt;add: &lt;/span&gt;&lt;span class="nf"&gt;(rank, task) =&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;@tasks&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;push&lt;/span&gt; &lt;span class="nv"&gt;rank: &lt;/span&gt;&lt;span class="nx"&gt;rank&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;task: &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;task&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;@run&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
	&lt;span class="nv"&gt;run: &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;@tasks&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;pop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;task&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Let’s give our new gear, &lt;code&gt;PrioritizedSequentialExecutor&lt;/code&gt;, a try.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="nv"&gt;exec = &lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nx"&gt;PrioritizedSequentialExecutor&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(next) -&amp;gt;&lt;/span&gt;
    &lt;span class="nx"&gt;db&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;open&lt;/span&gt; &lt;span class="s"&gt;"local"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err, conn) -&amp;gt;&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"connection error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
        &lt;span class="nv"&gt;exec.conn = &lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;
        &lt;span class="nx"&gt;next&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(next) -&amp;gt;&lt;/span&gt;
    &lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;query&lt;/span&gt; &lt;span class="s"&gt;"SELECT key, val FROM entries"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err, rows) -&amp;gt;&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"query error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;

        &lt;span class="c1"&gt;# Errounous dynamic task creation. exec.conn.close() will be evaluated&lt;/span&gt;
        &lt;span class="c1"&gt;# earlier then the insert tasks created within this task.&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="nx"&gt;row&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="nx"&gt;rows&lt;/span&gt;
            &lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(next) -&amp;gt;&lt;/span&gt;
                &lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;insert&lt;/span&gt; &lt;span class="nv"&gt;key: &lt;/span&gt;&lt;span class="nx"&gt;row&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;key&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;val: &lt;/span&gt;&lt;span class="nx"&gt;row&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;val&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(err) -&amp;gt;&lt;/span&gt;
                    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;error: &lt;/span&gt;&lt;span class="s"&gt;"insert error: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
                    &lt;span class="nx"&gt;next&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(next) -&amp;gt;&lt;/span&gt;
            &lt;span class="nx"&gt;user_send&lt;/span&gt;
            &lt;span class="nx"&gt;next&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

        &lt;span class="nx"&gt;next&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(next) -&amp;gt;&lt;/span&gt;
    &lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="nx"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;run&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="cm"&gt;###&lt;/span&gt;
&lt;span class="cm"&gt;Step | Command          | Priority&lt;/span&gt;
&lt;span class="cm"&gt;-----+------------------+---------&lt;/span&gt;
&lt;span class="cm"&gt;  1  | db.open          | 0&lt;/span&gt;
&lt;span class="cm"&gt;  2  | exec.conn.query  | 1&lt;/span&gt;
&lt;span class="cm"&gt;  3  | exec.conn.insert | 2&lt;/span&gt;
&lt;span class="cm"&gt;  4  | exec.conn.insert | 2&lt;/span&gt;
&lt;span class="cm"&gt; ...&lt;/span&gt;
&lt;span class="cm"&gt; n-2 | exec.conn.insert | 2&lt;/span&gt;
&lt;span class="cm"&gt; n-1 | exec.conn.close  | 3&lt;/span&gt;
&lt;span class="cm"&gt;  n  | user_send        | 4&lt;/span&gt;
&lt;span class="cm"&gt;###&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Mission accomplished! Now we have a fully-fledged sequencer where we can dynamically push tasks with different priorities.&lt;/p&gt;

&lt;p&gt;Note that while &lt;code&gt;PrioritizedSequentialExecutor&lt;/code&gt; is quite good at doing what it is advertised for, especially compared to the lines of code written, there exists other libraries (e.g., &lt;a href="https://github.com/substack/node-seq"&gt;seq&lt;/a&gt;, &lt;a href="https://github.com/substack/node-chainsaw"&gt;chainsaw&lt;/a&gt;, &lt;a href="https://github.com/coolaj86/futures"&gt;futures&lt;/a&gt;, &lt;a href="https://github.com/caolan/async"&gt;async&lt;/a&gt;, &lt;a href="https://github.com/JeffreyZhao/wind"&gt;windjs&lt;/a&gt;, &lt;a href="https://github.com/Sage/streamlinejs"&gt;streamlinejs&lt;/a&gt;, etc.) with similar flow-control purposes. While you are at it, you might want to check them out too.&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2012-09-16://blog/post/2012/09/16/an-authentication-service-for-angularjs/</id>
    <title type="html">An Authentication Service for AngularJS</title>
    <published>2012-09-16T13:31:00Z</published>
    <updated>2012-09-16T13:31:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2012/09/16/an-authentication-service-for-angularjs/"/>
    <content type="html">&lt;p&gt;I am so tired to form up explanatory, coherent sentences, but at the same time I really like to share a user authentication service that I wrote for &lt;a href="http://www.angularjs.org/"&gt;AngularJS&lt;/a&gt;. Hence, pardon my brevity.&lt;/p&gt;

&lt;p&gt;In this example I use RailwayJS with CoffeeScript both at the client- and server-side. (See my previous &lt;a href="/blog/post/2012/09/16/auto-compiling-assets-with-connect-assets/"&gt;post&lt;/a&gt; on auto-compiling assets with connect-assets.) Here is the scenario: You have &lt;code&gt;assignments.html&lt;/code&gt; such that only authenticated users are allowed.&lt;/p&gt;

&lt;p&gt;First things first, here is our &lt;code&gt;/config/routes.coffee&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="nv"&gt;exports.routes = &lt;/span&gt;&lt;span class="nf"&gt;(map)-&amp;gt;&lt;/span&gt;
  &lt;span class="nx"&gt;map&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;post&lt;/span&gt;  &lt;span class="s"&gt;'/login'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;                   &lt;span class="s"&gt;'home#login'&lt;/span&gt;
  &lt;span class="nx"&gt;map&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;post&lt;/span&gt;  &lt;span class="s"&gt;'/logout'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;                  &lt;span class="s"&gt;'home#logout'&lt;/span&gt;
  &lt;span class="nx"&gt;map&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;get&lt;/span&gt;   &lt;span class="s"&gt;'/'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;                        &lt;span class="s"&gt;'home#index'&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then we implement our controller &lt;code&gt;/app/controllers/home_controller.coffee&lt;/code&gt; as follows.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="nv"&gt;moment = &lt;/span&gt;&lt;span class="nx"&gt;require&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'moment'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="nx"&gt;action&lt;/span&gt; &lt;span class="s"&gt;'index'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="nx"&gt;render&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;user: &lt;/span&gt;&lt;span class="nx"&gt;request&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;session&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="nx"&gt;action&lt;/span&gt; &lt;span class="s"&gt;'login'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="nx"&gt;authenticate&lt;/span&gt; &lt;span class="nx"&gt;request&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;body&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;username&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;request&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;body&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;password&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(ret) -&amp;gt;&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;ret&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="nv"&gt;request.session.user =&lt;/span&gt;
                &lt;span class="nv"&gt;name: &lt;/span&gt;&lt;span class="nx"&gt;request&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;body&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;username&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                &lt;span class="nv"&gt;time: &lt;/span&gt;&lt;span class="nx"&gt;moment&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="nx"&gt;unix&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="nx"&gt;send&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;result: &lt;/span&gt;&lt;span class="nx"&gt;ret&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="nx"&gt;action&lt;/span&gt; &lt;span class="s"&gt;'logout'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="nx"&gt;request&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;session&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;destroy&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="nx"&gt;redirect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'/'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note that the &lt;code&gt;authenticate&lt;/code&gt; used in &lt;code&gt;login&lt;/code&gt; action handler is meant to be provided by you.&lt;/p&gt;

&lt;p&gt;Later, we write &lt;code&gt;/app/views/home/index.ejs&lt;/code&gt; to fire up AngularJS:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-html"&gt;&lt;span class="nt"&gt;&amp;lt;div&lt;/span&gt; &lt;span class="na"&gt;ng-app=&lt;/span&gt;&lt;span class="s"&gt;"project"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="err"&gt;&amp;lt;&lt;/span&gt;%- javascript_include_tag('angular', 'angular-resource') %&amp;gt;
    &lt;span class="err"&gt;&amp;lt;&lt;/span&gt;%- js('app') %&amp;gt;
    &lt;span class="err"&gt;&amp;lt;&lt;/span&gt;%- js('controllers') %&amp;gt;
    &lt;span class="err"&gt;&amp;lt;&lt;/span&gt;%- js('services') %&amp;gt;
    &lt;span class="nt"&gt;&amp;lt;div&lt;/span&gt; &lt;span class="na"&gt;ng-view&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We first start by implementing &lt;code&gt;app.js&lt;/code&gt; of AngularJS in &lt;code&gt;/assets/js/app.coffee&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="nx"&gt;angular&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;module&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'project'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;'projectServices'&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
    &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;config&lt;/span&gt; &lt;span class="nf"&gt;($routeProvider) -&amp;gt;&lt;/span&gt;
        &lt;span class="nx"&gt;$routeProvider&lt;/span&gt;
            &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;when&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'/login'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                &lt;span class="nv"&gt;templateUrl: &lt;/span&gt;&lt;span class="s"&gt;'partials/login.html'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                &lt;span class="nv"&gt;controller: &lt;/span&gt;&lt;span class="nx"&gt;LoginCtrl&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;when&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'/assignments'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                &lt;span class="nv"&gt;templateUrl: &lt;/span&gt;&lt;span class="s"&gt;'partials/assignments.html'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                &lt;span class="nv"&gt;controller: &lt;/span&gt;&lt;span class="nx"&gt;AssignmentListCtrl&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;otherwise&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;redirectTo: &lt;/span&gt;&lt;span class="s"&gt;'/login'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;run&lt;/span&gt; &lt;span class="nf"&gt;($rootScope, $location, User) -&amp;gt;&lt;/span&gt;
        &lt;span class="nx"&gt;$rootScope&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;$watch&lt;/span&gt; &lt;span class="o"&gt;\&lt;/span&gt;
            &lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="nf"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;$location&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;path&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;
            &lt;span class="nf"&gt;(next, prev) -&amp;gt;&lt;/span&gt;
                &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;not&lt;/span&gt; &lt;span class="nx"&gt;User&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;isAuthenticated&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;and&lt;/span&gt; &lt;span class="nx"&gt;next&lt;/span&gt; &lt;span class="o"&gt;isnt&lt;/span&gt; &lt;span class="s"&gt;'/login'&lt;/span&gt;
                    &lt;span class="nx"&gt;$location&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;path&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"/login"&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
            &lt;span class="kc"&gt;true&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The extra bit for watching on &lt;code&gt;$rootScope&lt;/code&gt; is to check access to authentication required pages.&lt;/p&gt;

&lt;p&gt;After &lt;code&gt;app.js&lt;/code&gt;, we implement &lt;code&gt;/assets/js/controllers.coffee&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="nb"&gt;window&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nv"&gt;LoginCtrl = &lt;/span&gt;&lt;span class="nf"&gt;($scope, $location, User) -&amp;gt;&lt;/span&gt;
    &lt;span class="nv"&gt;$scope.login = &lt;/span&gt;&lt;span class="nf"&gt;-&amp;gt;&lt;/span&gt;
        &lt;span class="nx"&gt;User&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;login&lt;/span&gt; &lt;span class="nx"&gt;$scope&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;username&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;$scope&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;password&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;(result) -&amp;gt;&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="nx"&gt;result&lt;/span&gt;
                &lt;span class="nb"&gt;window&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;alert&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'Authentication failed!'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;else&lt;/span&gt;
                &lt;span class="nx"&gt;$scope&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;$apply&lt;/span&gt; &lt;span class="nf"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;$location&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;path&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'/assignments'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="nb"&gt;window&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nv"&gt;AssignmentListCtrl = &lt;/span&gt;&lt;span class="nf"&gt;($scope, User) -&amp;gt;&lt;/span&gt;
    &lt;span class="nv"&gt;$scope.User = &lt;/span&gt;&lt;span class="nx"&gt;User&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;For each controller, we implement a view, that is, &lt;code&gt;/public/partials/login.html&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-html"&gt;&lt;span class="nt"&gt;&amp;lt;div&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;form&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;label&amp;gt;&lt;/span&gt;Username: &lt;span class="nt"&gt;&amp;lt;input&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;"text"&lt;/span&gt; &lt;span class="na"&gt;ng-model=&lt;/span&gt;&lt;span class="s"&gt;"username"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&amp;lt;/label&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;label&amp;gt;&lt;/span&gt;Password: &lt;span class="nt"&gt;&amp;lt;input&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;"password"&lt;/span&gt; &lt;span class="na"&gt;ng-model=&lt;/span&gt;&lt;span class="s"&gt;"password"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&amp;lt;/label&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;button&lt;/span&gt; &lt;span class="na"&gt;ng-click=&lt;/span&gt;&lt;span class="s"&gt;"login()"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;Login&lt;span class="nt"&gt;&amp;lt;/button&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;/form&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and &lt;code&gt;/public/partials/assignments.html&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-html"&gt;&lt;span class="nt"&gt;&amp;lt;p&amp;gt;&lt;/span&gt;Welcome, {{User.getName()}}!&lt;span class="nt"&gt;&amp;lt;/p&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;button&lt;/span&gt; &lt;span class="na"&gt;ng-click=&lt;/span&gt;&lt;span class="s"&gt;"User.logout()"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;Logout&lt;span class="nt"&gt;&amp;lt;/button&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And here goes the magic, &lt;code&gt;/assets/js/services.coffee&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-coffeescript"&gt;&lt;span class="nx"&gt;angular&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;module&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'projectServices'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[])&lt;/span&gt;
    &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;factory&lt;/span&gt; &lt;span class="s"&gt;'User'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nf"&gt;-&amp;gt;&lt;/span&gt;
        &lt;span class="vi"&gt;@authenticated = &lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;
        &lt;span class="vi"&gt;@name = &lt;/span&gt;&lt;span class="kc"&gt;null&lt;/span&gt;
        &lt;span class="nv"&gt;isAuthenticated: &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;@authenticated&lt;/span&gt;
        &lt;span class="nv"&gt;getName: &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;@name&lt;/span&gt;
        &lt;span class="nv"&gt;login: &lt;/span&gt;&lt;span class="nf"&gt;(username, password, callback) =&amp;gt;&lt;/span&gt;
            &lt;span class="nx"&gt;$&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;post&lt;/span&gt; &lt;span class="s"&gt;'/login'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nv"&gt;username: &lt;/span&gt;&lt;span class="nx"&gt;username&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;password: &lt;/span&gt;&lt;span class="nx"&gt;password&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
                &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;(data) =&amp;gt;&lt;/span&gt;
                    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;data&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;result&lt;/span&gt;
                        &lt;span class="vi"&gt;@name = &lt;/span&gt;&lt;span class="nx"&gt;username&lt;/span&gt;
                        &lt;span class="vi"&gt;@authenticated = &lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;
                    &lt;span class="nx"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;data&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;result&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
                &lt;span class="s"&gt;'json'&lt;/span&gt;
        &lt;span class="nv"&gt;logout: &lt;/span&gt;&lt;span class="nf"&gt;(callback) =&amp;gt;&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;@authenticated&lt;/span&gt;
                &lt;span class="nx"&gt;$&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;post&lt;/span&gt; &lt;span class="s"&gt;'/logout'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{},&lt;/span&gt;
                    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;(data) =&amp;gt;&lt;/span&gt;
                        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nx"&gt;data&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;result&lt;/span&gt;
                            &lt;span class="vi"&gt;@authenticated = &lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
                        &lt;span class="nx"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;data&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;result&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
                    &lt;span class="s"&gt;'json'&lt;/span&gt;
            &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="nx"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Hope it works for you as well.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Edit:&lt;/strong&gt; Thanks &lt;a href="https://plus.google.com/100882799970411374993"&gt;Krisztián Kerék&lt;/a&gt; for spotting the routing problem related with listening on &lt;code&gt;$rootScope&lt;/code&gt; for &lt;code&gt;$routeChangeStart&lt;/code&gt;. Replaced it with &lt;code&gt;$rootScope.$watch&lt;/code&gt; as suggested in &lt;a href="http://stackoverflow.com/a/15029387/1278899"&gt;this&lt;/a&gt; StackOverflow post.&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2012-09-16://blog/post/2012/09/16/auto-compiling-assets-with-connect-assets/</id>
    <title type="html">Auto-Compiling Assets with connect-assets</title>
    <published>2012-09-16T10:19:00Z</published>
    <updated>2012-09-16T10:19:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2012/09/16/auto-compiling-assets-with-connect-assets/"/>
    <content type="html">&lt;p&gt;I have been using &lt;a href="http://www.railwayjs.com/"&gt;RailwayJS&lt;/a&gt; for a couple of weeks with great satisfaction and joy. Its built-in support for CoffeeScript files is fantastic. That being said, like a majority of other &lt;a href="http://www.nodejs.org"&gt;NodeJS&lt;/a&gt; web frameworks (e.g. &lt;a href="http://geddyjs.org/"&gt;Geddy&lt;/a&gt;, &lt;a href="http://towerjs.org/"&gt;Tower.js&lt;/a&gt;, &lt;a href="http://www.socketstream.org/"&gt;SocketStream&lt;/a&gt;, &lt;a href="http://flatironjs.org/"&gt;FlatIron&lt;/a&gt;) it doesn’t provide a way to ship client-side CoffeeScript files. (In this context, &lt;a href="http://www.meteor.com/"&gt;Meteor&lt;/a&gt; represents a notable exception, where it is capable of handling CoffeeScript files both at the server- and client-side.)&lt;/p&gt;

&lt;p&gt;To establish a complete CoffeeScript experience both at the server- and client-side, one can use &lt;a href="https://github.com/TrevorBurnham/connect-assets"&gt;connect-assets&lt;/a&gt; by &lt;a href="http://trevorburnham.com/"&gt;Trevor Burnham&lt;/a&gt; to auto-compile &lt;em&gt;assets&lt;/em&gt; (i.e., CoffeeScript, Stylus, LESS files) on-the-fly. For this purpose, you just need to (1) add a &lt;code&gt;app.use require('connect-assets')()&lt;/code&gt; line to your &lt;code&gt;environment.coffee&lt;/code&gt;, (2) create &lt;code&gt;js&lt;/code&gt; and &lt;code&gt;css&lt;/code&gt; folders under &lt;code&gt;assets&lt;/code&gt; directory, and you are ready to go.&lt;/p&gt;

&lt;p&gt;One minor glitch that you need to pay attention is, while using connect-assets, you &lt;em&gt;must&lt;/em&gt; include asset files using accessor functions – &lt;code&gt;js()&lt;/code&gt; and &lt;code&gt;css()&lt;/code&gt; – provided by connect-assets. These functions in addition to generating necessary &lt;code&gt;&amp;lt;script src="..."&amp;gt;&amp;lt;/script&amp;gt;&lt;/code&gt; tag, also register the file into the asset processor service. connect-assets auto-compiles an asset the first time it is called and caches the produced output in memory; later calls will be served from the cache. (It also provides options to write produced outputs to disk and watch file changes.) For instance, say you want to use &lt;code&gt;/assets/js/main.coffee&lt;/code&gt; in &lt;code&gt;/app/views/main/index.ejs&lt;/code&gt; file. For this purpose, you need to add &lt;code&gt;&amp;lt;%- js('main') %&amp;gt;&lt;/code&gt; into your view for enabling connect-assets serving your &lt;code&gt;main.coffee&lt;/code&gt; file.&lt;/p&gt;

&lt;p&gt;As a final note, since connect-assets is a &lt;a href="http://www.senchalabs.org/connect/"&gt;Connect&lt;/a&gt; plugin, you should be able to run it on any other web framework that runs on Connect or &lt;a href="http://expressjs.com/"&gt;ExpressJS&lt;/a&gt;.&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2012-06-21://blog/post/2012/06/21/rpc-with-hazelcast/</id>
    <title type="html">RPC (Remote Procedure Call) with Hazelcast</title>
    <published>2012-06-21T11:16:00Z</published>
    <updated>2012-06-21T11:16:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2012/06/21/rpc-with-hazelcast/"/>
    <content type="html">&lt;p&gt;Despite the fact that &lt;a href="http://www.hazelcast.com/"&gt;Hazelcast&lt;/a&gt; is a data distribution (particularly, peer-to-peer) platform for Java, its group communication mechanics can be utilized for remote procedure calls in a similar fashion to &lt;a href="http://vyazici.blogspot.com/2012/04/rpc-remote-procedure-call-with-jgroups.html"&gt;JGroups remote procedure calls&lt;/a&gt;. Further, to ease this workflow, Hazelcast provides &lt;a href="http://hazelcast.com/docs/2.1/manual/multi_html/ch09.html"&gt;distributed executor service&lt;/a&gt; to execute &lt;a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/Callable.html"&gt;&lt;code&gt;Callable&lt;/code&gt;&lt;/a&gt; and &lt;a href="http://docs.oracle.com/javase/6/docs/api/java/lang/Runnable.html"&gt;&lt;code&gt;Runnable&lt;/code&gt;&lt;/a&gt; instances on the remote cluster members. Now, let’s glue things together for making remote procedure calls on Hazelcast cluster members.&lt;/p&gt;

&lt;p&gt;Assuming that you have some familiarity with executor services, check out below &lt;code&gt;SimpleRPC&lt;/code&gt; class, which makes use of the Hazelcast executor service to invoke a &lt;code&gt;Call&lt;/code&gt; instance on every cluster member.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.hazelcast.core.Hazelcast&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.hazelcast.core.MultiTask&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.Arrays&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.Collection&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.concurrent.ExecutionException&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.concurrent.ExecutorService&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.concurrent.TimeUnit&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.concurrent.TimeoutException&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;SimpleRPC&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;SimpleRPC&lt;/span&gt; &lt;span class="n"&gt;instance&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="nf"&gt;SimpleRPC&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;SimpleRPC&lt;/span&gt; &lt;span class="nf"&gt;getInstance&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;instance&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;instance&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;SimpleRPC&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;instance&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="nd"&gt;@SuppressWarnings&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"unused"&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;boolean&lt;/span&gt; &lt;span class="nf"&gt;callMe&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;input&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;out&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;format&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"callMe('%s') is called!"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;input&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;callEvery&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;input&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
            &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;ExecutionException&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;TimeoutException&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;InterruptedException&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;MultiTask&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Boolean&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;task&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;MultiTask&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Boolean&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Call&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;input&lt;/span&gt;&lt;span class="o"&gt;),&lt;/span&gt;
                &lt;span class="n"&gt;Hazelcast&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getCluster&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;getMembers&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
        &lt;span class="n"&gt;ExecutorService&lt;/span&gt; &lt;span class="n"&gt;executorService&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Hazelcast&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getExecutorService&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
        &lt;span class="n"&gt;executorService&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;execute&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;task&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;Collection&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Boolean&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;results&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;task&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;TimeUnit&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;SECONDS&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;out&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;format&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"callEvery('%s'): %s"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
                &lt;span class="n"&gt;input&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Arrays&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;toString&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;results&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;toArray&lt;/span&gt;&lt;span class="o"&gt;())));&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;main&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;Exception&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;SimpleRPC&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getInstance&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;callEvery&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"foo bar baz"&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Since &lt;code&gt;SimpleRPC&lt;/code&gt; is a singleton, whose instance is accessible via its &lt;code&gt;getInstance()&lt;/code&gt; method, foreign classes can easily invoke its &lt;code&gt;callMe()&lt;/code&gt; instance method. Now let’s implement the &lt;code&gt;Call&lt;/code&gt; class, which is anticipated to encapsulate the necessary mechanics to make a call to &lt;code&gt;SimpleRPC.getInstance().callMe()&lt;/code&gt; on each cluster member.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.io.Serializable&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.concurrent.Callable&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Call&lt;/span&gt; &lt;span class="kd"&gt;implements&lt;/span&gt; &lt;span class="n"&gt;Callable&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Boolean&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;,&lt;/span&gt; &lt;span class="n"&gt;Serializable&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;input&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="nf"&gt;Call&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;input&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;input&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;input&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Boolean&lt;/span&gt; &lt;span class="nf"&gt;call&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;SimpleRPC&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getInstance&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;callMe&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;input&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Simple, eh?&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2012-06-04://blog/post/2012/06/04/performance-of-linux-ip-alias-lessons-learnt/</id>
    <title type="html">Performance of Linux IP Aliased Network Interfaces: Lessons Learnt</title>
    <published>2012-06-04T04:17:00Z</published>
    <updated>2012-06-04T04:17:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2012/06/04/performance-of-linux-ip-alias-lessons-learnt/"/>
    <content type="html">&lt;p&gt;In an earlier &lt;a href="/blog/post/2012/05/11/performance-of-linux-ip-alias/"&gt;post&lt;/a&gt;, I had put together a set of benchmarks to measure the performance of IP aliased network interfaces in Linux. While I was expecting a performance degredation due to IP aliasing related book keeping at the kernel level, suprisingly results were pointing out that the overall network throughput measured over the used physical interface increases proportional to the number of aliased interfaces. In this post, I will re-investigate the subject with the lessons I learnt from my previous try.&lt;/p&gt;

&lt;p&gt;To begin with, I want to address &lt;a href="http://utcc.utoronto.ca/~cks/"&gt;Chris Siebenmann&lt;/a&gt;’s &lt;a href="http://utcc.utoronto.ca/~cks/space/blog/tech/NetworkPerfBasicStep?showcomments"&gt;concerns&lt;/a&gt; regarding the raw performance of the used network interface card. For this purpose, I first replaced the NIC with a real one (RTL8111/8168B) that is capable of achieving gigabit rates. Then, I started playing with &lt;code&gt;iperf&lt;/code&gt; parameters. After a couple of tries, I figured out that the game changer is &lt;strong&gt;TCP MSS (maximum segment size)&lt;/strong&gt; for me. Setting MSS to 1448 helped me to boost my speed to gigabit rates. Other configurations (e.g., disabling TCP delays, i.e., Nagle’s algorithm) did not change the results that much, but I present them hereby anyway.&lt;/p&gt;

&lt;p&gt;New results are as follows. (Each pass is set to run for 60 seconds.)&lt;/p&gt;

&lt;table&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;em&gt;# of alias&lt;/em&gt;&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;8&lt;/td&gt;
      &lt;td&gt;16&lt;/td&gt;
      &lt;td&gt;32&lt;/td&gt;
      &lt;td&gt;64&lt;/td&gt;
    &lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;
&lt;em&gt;Kbits/sec&lt;/em&gt; (tcp)&lt;/td&gt;
      &lt;td&gt;920,462&lt;/td&gt;
      &lt;td&gt;921,468&lt;/td&gt;
      &lt;td&gt;921,311&lt;/td&gt;
      &lt;td&gt;920,909&lt;/td&gt;
      &lt;td&gt;920,679&lt;/td&gt;
      &lt;td&gt;920,770&lt;/td&gt;
      &lt;td&gt;922,861&lt;/td&gt;
    &lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;
&lt;em&gt;Kbits/sec&lt;/em&gt; (nodelay)&lt;/td&gt;
      &lt;td&gt;921,261&lt;/td&gt;
      &lt;td&gt;921,184&lt;/td&gt;
      &lt;td&gt;921,179&lt;/td&gt;
      &lt;td&gt;920,832&lt;/td&gt;
      &lt;td&gt;920,629&lt;/td&gt;
      &lt;td&gt;920,732&lt;/td&gt;
      &lt;td&gt;921,521&lt;/td&gt;
    &lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;em&gt;# of alias&lt;/em&gt;&lt;/td&gt;
      &lt;td&gt;96&lt;/td&gt;
      &lt;td&gt;128&lt;/td&gt;
      &lt;td&gt;160&lt;/td&gt;
      &lt;td&gt;192&lt;/td&gt;
      &lt;td&gt;224&lt;/td&gt;
      &lt;td&gt;254&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;
&lt;em&gt;Kbits/sec&lt;/em&gt; (tcp)&lt;/td&gt;
      &lt;td&gt;926,282&lt;/td&gt;
      &lt;td&gt;969,967&lt;/td&gt;
      &lt;td&gt;949,506&lt;/td&gt;
      &lt;td&gt;952,449&lt;/td&gt;
      &lt;td&gt;986,355&lt;/td&gt;
      &lt;td&gt;990,832&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;
&lt;em&gt;Kbits/sec&lt;/em&gt; (nodelay)&lt;/td&gt;
      &lt;td&gt;925,444&lt;/td&gt;
      &lt;td&gt;945,879&lt;/td&gt;
      &lt;td&gt;949,204&lt;/td&gt;
      &lt;td&gt;953,509&lt;/td&gt;
      &lt;td&gt;973,846&lt;/td&gt;
      &lt;td&gt;993,143&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;&lt;img src="results.jpg" alt="Results"&gt;&lt;/p&gt;

&lt;p&gt;Ok, the results are cool. But how do we explain them? For this purpose, by finding his name from Wikipedia &lt;a href="http://en.wikipedia.org/wiki/IP_aliasing"&gt;IP Aliasing&lt;/a&gt; page, I got in touch with &lt;strong&gt;&lt;a href="http://juanjosec.blogspot.com/"&gt;Juan José Ciarlante&lt;/a&gt; – the author of first IP aliasing support in Linux kernel in 1995&lt;/strong&gt; – and he kindly replied my questions. Below, I directly quote from his own words.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;you may be “just” exploiting the fact that you’re using more TCP connections (==N_WORKERS) as number of aliases increases, and thus increasing the “parallelism of your transferring pipes”, much in a way p2p networks do (spread the downloading between zillion of connections), suggest reading about TCP congestion window control semantics.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Finally, we have a valid answer!&lt;/p&gt;</content>
  </entry>
</feed>

